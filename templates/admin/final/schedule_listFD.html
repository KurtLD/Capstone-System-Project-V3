{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedules for Pre-Oral Defense</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'admin/pre_oral/schedule_listPOD.css' %}">
    <style>
        @media print {
            .page-break {
                page-break-before: always;
            }
            .avoid-page-break {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    {% if conflict %}
        <script>
            alert("{{message}}");
        </script>
    {% endif %}
    <div class="flex h-screen flex-col">
        <!-- Navbar -->
        <div class="no-print">
            {% include 'navbar.html' %}
        </div>
        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            {% include 'sidebar.html' %}
            <!-- Main Content Wrapper -->
            <div class="flex flex-col flex-1">
                <!-- Loader -->
                <div class="modal fade" id="loaderModal" tabindex="-1" role="dialog" aria-labelledby="loaderModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-body text-center">
                                <p id="progressText">Processing... 0%</p>
                                <div class="progress">
                                    <div id="progressBar" class="progress-bar progress-bar-animated progress-bar-custom" role="progressbar" style="width: 0%"></div>
                                </div>
                                <i id="successIcon" class="fas fa-check-circle success-icon" style="display: none;"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Content -->
                <main class="flex-1 overflow-auto main-content p-6 ">
                    <div class="container">
                        {% comment %} <div class="d-flex justify-content-between align-items-center mb-4">
                            <img src="{% static 'images/Evsu logo.png' %}" alt="Left Image" class="img-fluid" style="width: 90px; height: auto;">
                            <img src="{% static 'images/IT.png' %}" alt="Right Image" class="img-fluid" style="width: 90px; height: auto;">
                        </div> {% endcomment %}
                        <div class="buttons">
                            <form method="post" action="" id="scheduleForm">
                                {% csrf_token %}
                                {% if selected_school_year == last_school_year %}
                                    <div class="no-print date-picker">
                                        <label class="no-print" for="start_date">Select Start Date:</label>
                                        <input type="date" id="start_date" name="start_date" required>
                                    </div>
                                {% endif %}
                                <div class="button-group no-print">
                                    {% if grouped_schedulesFD %}
                                        <div class="dropdown">
                                            <button class="no-print same-size-button dropdown-toggle" type="button" id="printDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                Print
                                            </button>
                                            <ul class="dropdown-menu small-text" aria-labelledby="printDropdown">
                                                {% for day in grouped_schedulesFD|unique_days %}
                                                    <li><a class="dropdown-item" href="#" onclick="printPage('{{ day }}')">{{ day }}</a></li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endif %}
                                    {% if selected_school_year == last_school_year %}
                                        {% if not grouped_schedulesFD %}
                                           <button class="no-print same-size-button" type="submit" name="generate_schedule_view_POD">Generate</button>
                                        {% else %}
                                           <button class="no-print same-size-button" type="submit" name="generate_again_POD">Re-Generate</button>
                                           <button class="no-print same-size-button btn btn-secondary" onclick="window.location.href='{% url 'faculty_tallyFD' %}';">Faculty Tally</button>
                                           <!-- Button trigger modal -->
                                            <button class="no-print same-size-button btn btn-secondary" data-toggle="modal" data-target="#confirmationModal">
                                                Reset
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </form>
                        </div>
                        <script>
                            function validateForm() {
                                const startDate = document.getElementById('start_date').value;
                                if (!startDate) {
                                    alert('Please select a start date.');
                                    return false;
                                }
                                showLoader();
                                return true;
                            }
                        
                            function showLoader() {
                                $('#loaderModal').modal('show');
                                let progressBar = document.getElementById('progressBar');
                                let progressText = document.getElementById('progressText');
                                let successIcon = document.getElementById('successIcon');
                                let width = 0;
                                let interval = setInterval(function() {
                                    if (width >= 100) {
                                        clearInterval(interval);
                                        successIcon.style.display = 'block'; // Show success icon
                                    } else {
                                        width += 10; // Increase progress by 10%
                                        progressBar.style.width = width + '%';
                                        progressBar.setAttribute('aria-valuenow', width);
                                        progressText.innerText = 'Processing... ' + width + '%';
                                    }
                                }, 100); // Update every 100ms
                            }
                        
                            document.getElementById('scheduleForm').addEventListener('submit', function(event) {
                                if (!validateForm()) {
                                    event.preventDefault();
                                }
                            });
                        </script>

                        <br><br><br>
                        <div class="schedule-container">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="header">Schedule for Upcoming Final Defense</h2>
                                <div class="col-md-4">
                                    <input type="text" id="myInput" class="form-control search-bar" placeholder="Search for schedule...">
                                </div>
                            </div>
                            {% if grouped_schedulesFD %}
                                {% for day_room, schedulesFD in grouped_schedulesFD.items %}
                                    {% if day_room|length == 3 %}
                                        <div class="page-break">
                                            <br>
                                            <h3>{{ day_room.0 }}</h3>
                                            <h4>
                                                Date: <span class="highlight">{{ day_room.1 }}</span><br>
                                                Room: <span class="highlight">{{ day_room.2 }}</span>
                                            </h4>
                                            <table class="table table-striped schedule-table" data-room="{{ day_room.2 }}">
                                                <thead>
                                                    <tr>
                                                        <th>Time</th>
                                                        <th>Group Members</th>
                                                        <th>Section</th>
                                                        <th>Title</th>
                                                        <th>Panelists</th>
                                                        <th>Adviser</th>
                                                        <th class="no-print">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for schedule in schedulesFD %}
                                                        {% if not schedule.has_been_rescheduled %}
                                                            {% if schedule.new_sched %}
                                                                <tr class="avoid-page-break" style="background-color: #00ff55;">
                                                                    <td data-label="Time">{{ schedule.slot }}</td>
                                                                    <td class="group-members" data-label="Group Members">
                                                                        {{ schedule.group.member1 }}<br>
                                                                        {{ schedule.group.member2 }}<br>
                                                                        {{ schedule.group.member3 }}
                                                                    </td>
                                                                    <td data-label="Section">{{ schedule.group.section }} ({{ schedule.group.capstone_teacher.name }})</td>
                                                                    <td data-label="Title">{{ schedule.group.title }}</td>
                                                                    <td class="panels" data-label="Panelists">
                                                                        <div style="background-color: #5b97f8; padding: 3px; display: inline-block; border-radius: 3px;font-weight: bold;">
                                                                            {{ schedule.faculty1.name }} {% if schedule.faculty1 == faculty_member %}<span class="role">(Panelist)</span>{% endif %}
                                                                        </div>
                                                                        <div style="padding: 3px;">
                                                                            {{ schedule.faculty2.name }} {% if schedule.faculty2 == faculty_member %}<span class="role">(Panelist)</span>{% endif %}
                                                                        </div>
                                                                        <div style="padding: 3px;">
                                                                            {{ schedule.faculty3.name }} {% if schedule.faculty3 == faculty_member %}<span class="role">(Panelist)</span>{% endif %}
                                                                        </div>
                                                                    </td>
                                                                    <td data-label="Adviser">{{ schedule.group.adviser.name }}</td>
                                                                    {% if selected_school_year == last_school_year %}
                                                                        <td class="no-print" data-label="Action">
                                                                            {% if schedule.has_been_rescheduled %}
                                                                                HAS BEEN RESCHEDULED!
                                                                            {% else %}
                                                                                <a href="#" class="buttons" data-bs-toggle="modal" data-bs-target="#actionModal" data-schedule-id="{{ schedule.id }}" data-current-slot="{{ schedule.slot }}" data-current-date="{{ schedule.date }}">Reschedule</a>
                                                                            {% endif %}
                                                                        </td>
                                                                    {% else %}
                                                                        <td><i>Not Available</i></td>
                                                                    {% endif %}
                                                                </tr>
                                                            {% else %}
                                                                <tr class="avoid-page-break">
                                                                    <td data-label="Time">{{ schedule.slot }}</td>
                                                                    <td class="group-members" data-label="Group Members">
                                                                        {{ schedule.group.member1 }}<br>
                                                                        {{ schedule.group.member2 }}<br>
                                                                        {{ schedule.group.member3 }}
                                                                    </td>
                                                                    <td data-label="Section">{{ schedule.group.section }} ({{ schedule.group.capstone_teacher.name }})</td>
                                                                    <td data-label="Title">{{ schedule.group.title }}</td>
                                                                    <td class="panels" data-label="Panelists">
                                                                        <div style="background-color: #5b97f8; padding: 3px; display: inline-block; border-radius: 3px;font-weight: bold;">
                                                                            {{ schedule.faculty1.name }} {% if schedule.faculty1 == faculty_member %}<span class="role">(Panelist)</span>{% endif %}
                                                                        </div>
                                                                        <div style="padding: 3px;">
                                                                            {{ schedule.faculty2.name }} {% if schedule.faculty2 == faculty_member %}<span class="role">(Panelist)</span>{% endif %}
                                                                        </div>
                                                                        <div style="padding: 3px;">
                                                                            {{ schedule.faculty3.name }} {% if schedule.faculty3 == faculty_member %}<span class="role">(Panelist)</span>{% endif %}
                                                                        </div>
                                                                    </td>
                                                                    <td data-label="Adviser">{{ schedule.group.adviser.name }}</td>
                                                                    {% if selected_school_year == last_school_year %}
                                                                        <td class="no-print" data-label="Action">
                                                                            {% if schedule.has_been_rescheduled %}
                                                                                HAS BEEN RESCHEDULED!
                                                                            {% else %}
                                                                                <a href="#" class="buttons" data-bs-toggle="modal" data-bs-target="#actionModal" data-schedule-id="{{ schedule.id }}" data-current-slot="{{ schedule.slot }}" data-current-date="{{ schedule.date }}">Reschedule</a>
                                                                            {% endif %}
                                                                        </td>
                                                                    {% else %}
                                                                        <td><i>Not Available</i></td>
                                                                    {% endif %}
                                                                </tr>
                                                            {% endif %}
                        
                                                            {% if schedule.slot == "9:30AM-11AM" %}
                                                                <tr class="lunch-break">
                                                                    <td colspan="7" class="highlights">11AM-12PM Lunch Break</td>
                                                                </tr>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <p>Error: day_room does not contain exactly 3 elements.</p>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <br>
                                <h3 style="text-align: center;"><i>No Records Found.</i></h3>
                            {% endif %}
                        </div>
                        
                        <!-- Include jQuery -->
                        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                        <script>
                            $(document).ready(function() {
                                $("#myInput").on("keyup", function() {
                                    var value = $(this).val().toLowerCase();
                                    $(".schedule-table").each(function() {
                                        var hasVisibleRows = false;
                                        var table = $(this);
                                        table.find("tbody tr").filter(function() {
                                            var isVisible = $(this).text().toLowerCase().indexOf(value) > -1;
                                            $(this).toggle(isVisible);
                                            if (isVisible) {
                                                hasVisibleRows = true;
                                            }
                                        });
                                        if (!hasVisibleRows) {
                                            table.find("thead").hide();
                                            table.find("tbody").append('<tr class="no-results"><td colspan="7" class="text-center">No matching schedule found</td></tr>');
                                        } else {
                                            table.find("thead").show();
                                            table.find("tbody .no-results").remove();
                                        }
                                    });
                                });
                            });
                        </script>
                        <br><br>
                    </div>
                </main>
                <footer class="footer no-print">
                    {% include 'footer.html' %}
                </footer>
            </div>
         </div>
    </div>

    {% if new_group and new_schedule %}
        <style>
            /* Modal background */
            .modal-overlay {
                display: block; /* Set to "none" to hide initially */
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            }

            /* Modal box */
            .modal-content {
                background: white;
                padding: 20px;
                border-radius: 5px;
                width: 600px;
                text-align: left;
            }

            /* Close button */
            .close-btn {
                margin-top: 15px;
                padding: 8px 16px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            }
        </style>

        <!-- Modal HTML Structure -->
        <div class="modal-overlay" id="modal">
            <div class="modal-content">
                <p>The New schedule of <br> <strong>{{ new_group|safe }}</strong> is</p>
                <p><strong>Time:</strong> {{ new_schedule.slot }}</p>
                <p><strong>Date:</strong> {{ new_schedule.date }}</p>
                <p><strong>Day:</strong> {{ new_schedule.day }}</p>
                <p><strong>Room:</strong> {{ new_schedule.room }}</p>
                <button class="close-btn" onclick="closeModal()">Close</button>
            </div>
        </div>

        <script>
            // JavaScript to show modal on load
            document.addEventListener("DOMContentLoaded", function() {
                document.getElementById("modal").style.display = "flex";
            });

            // Function to close modal
            function closeModal() {
                document.getElementById("modal").style.display = "none";
            }
        </script>
    {% endif %}

    <!-- Modal for Confirm Reschedule -->
    <div class="modal fade" id="rescheduleModal" tabindex="-1" role="dialog" aria-labelledby="rescheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rescheduleModalLabel">
                        <i class="fa fa-calendar-alt" style="color: #007bff;"></i>
                        Confirm Reschedule
                    </h5>
                </div>
                <div class="modal-body">
                    Do you really want to reschedule this item? You'll be unable to reverse this!
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmRescheduleBtn">Yes, reschedule it!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Reassign -->
    <div class="modal fade" id="reassignModal" tabindex="-1" role="dialog" aria-labelledby="reassignModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reassignModalLabel">
                        <i class="fa fa-sync-alt" style="color: #007bff;"></i>
                        <span>Re-assign Schedule</span>
                    </h5>
                </div>
                <div class="modal-body">
                    <!-- <input type="text" id="last_used_date" name="last_used_date" value="{{ last_used_date }}"> -->
                    <label for="current_date">Current Date:</label>
                    <input type="text" id="current_date" class="form-control" readonly>
                    <label for="current_time" class="mt-2">Current Time Slot:</label>
                    <input type="text" id="current_time" class="form-control" readonly>
                    <label for="new_date" class="mt-2">Select new date:</label>
                    <input type="date" id="new_date" name="new_date" class="form-control">
                    <label for="new_time" class="mt-2">Select new time:</label>
                    <select id="new_time" class="form-control">
                        <option value="" disabled selected>--------</option>
                        <option value="8AM-9:30AM">8AM-9:30AM</option>
                        <option value="9:30AM-11AM">9:30AM-11AM</option>
                        <option value="12PM-01:30PM">12PM-01:30PM</option>
                        <option value="1:30PM-3PM">1:30PM-3PM</option>
                        <option value="3PM-4:30PM">3PM-4:30PM</option>
                        <option value="4:30PM-5PM">4:30PM-5PM</option>
                        <option value="5PM-6:30PM">5PM-6:30PM</option>
                    </select>
                    <label for="new_lab" class="mt-2">Select Room:</label>
                    <select id="new_lab" class="form-control">
                        <option value="" disabled selected>--------</option>
                        {% for room in rooms %}
                            <option value="{{ room.id }}">{{ room.name }}</option>
                        {% endfor %}
                    </select>
                    <input type="hidden" id="last_used_date" name="last_used_date" value="{{ last_used_date }}" class="form-control">
                    <div id="error_message" class="text-danger mt-2" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmReassignBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Modal for Scheduling -->
    <div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionModalLabel">
                        <i class="fas fa-calendar-alt" style="color: #007bff;"></i>
                        Schedule By:
                    </h5>
                </div>
                <div class="modal-body">
                    <p>Please choose how you would like to schedule the event:</p>
                </div>
                <div class="modal-btn">
                    <button type="button" class="btn btn-secondary" id="reassignBtn">Manual</button>
                    <button type="button" class="btn btn-danger" id="rescheduleBtn">Automatic</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const sidebarToggle = document.getElementById("sidebarToggle");
            const sidebar = document.getElementById("sidebar");
    
            // Retrieve the sidebar state from localStorage
            const sidebarState = localStorage.getItem("sidebarState");
            if (sidebarState === "closed") {
                sidebar.classList.add("hidden");
            }
    
            // Sidebar toggle functionality
            if (sidebarToggle) {
                sidebarToggle.addEventListener("click", function (event) {
                    event.preventDefault();
                    sidebar.classList.toggle("hidden");
    
                    // Store the sidebar state in localStorage
                    localStorage.setItem("sidebarState", sidebar.classList.contains("hidden") ? "closed" : "open");
                });
            }
    
            // Function to ensure the sidebar remains closed
            function ensureSidebarClosed() {
                if (!sidebar.classList.contains("hidden")) {
                    sidebar.classList.add("hidden");
                    localStorage.setItem("sidebarState", "closed");
                }
            }
    
            // Function for printing the page
            window.printPage = function(day) {
                ensureSidebarClosed();  // Ensure the sidebar is closed before printing
                const allSchedules = document.querySelectorAll('.schedule-container .page-break');
                allSchedules.forEach(schedule => {
                    if (!schedule.querySelector('h3').innerText.includes(day)) {
                        schedule.style.display = 'none';
                    }
                });
                window.print();
                allSchedules.forEach(schedule => {
                    schedule.style.display = 'block';
                });
            };

            // Confirm rescheduling without closing the sidebar
            window.confirmReschedule = function(scheduleId) {
                $('#rescheduleModal').modal('show');
                document.getElementById('confirmRescheduleBtn').onclick = function() {
                    const url = `/rescheduleFD/${scheduleId}/`;
                    window.location.href = url;
                };
            };

            // Event listener for action modal show event
            $('#actionModal').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget);  // Button that triggered the modal
                const scheduleId = button.data('schedule-id');  // Extract info from data-* attributes
                const currentSlot = button.data('current-slot');  // Extract current time slot
                const currentDate = button.data('current-date');  // Extract current date

                // Set up reschedule button
                document.getElementById('rescheduleBtn').onclick = function() {
                    $('#actionModal').modal('hide');
                    confirmReschedule(scheduleId);
                };

                // Set up reassign button
                document.getElementById('reassignBtn').onclick = function() {
                    $('#actionModal').modal('hide');
                    $('#reassignModal').modal('show');
                    const modal = $('#reassignModal');
                    modal.find('#current_time').val(currentSlot);  // Set the current time slot in the modal
                    modal.find('#current_date').val(currentDate);  // Set the current date in the modal

                    // Clear previous error messages and remove error class when the modal is shown
                    modal.on('shown.bs.modal', function () {
                        document.getElementById('error_message').style.display = 'none';
                        document.getElementById('error_message').innerHTML = '';
                        document.getElementById('new_date').classList.remove('is-invalid');
                        document.getElementById('new_time').classList.remove('is-invalid');
                        document.getElementById('new_lab').classList.remove('is-invalid');
                    });

                    document.getElementById('confirmReassignBtn').onclick = function() {
                        const newDate = document.getElementById('new_date').value;
                        const newTime = document.getElementById('new_time').value;
                        const newLab = document.getElementById('new_lab').value;
                        const last_used_date = document.getElementById('last_used_date').value;
                        const errorMessage = document.getElementById('error_message');
                        let errors = [];

                        // Validate fields
                        if (!newDate) {
                            errors.push('Please select a new date.');
                            document.getElementById('new_date').classList.add('is-invalid');
                        } else {
                            document.getElementById('new_date').classList.remove('is-invalid');
                        }
                        if (!newTime) {
                            errors.push('Please select a new time.');
                            document.getElementById('new_time').classList.add('is-invalid');
                        } else {
                            document.getElementById('new_time').classList.remove('is-invalid');
                        }
                        if (!newLab) {
                            errors.push('Please select a room.');
                            document.getElementById('new_lab').classList.add('is-invalid');
                        } else {
                            document.getElementById('new_lab').classList.remove('is-invalid');
                        }

                        // Date comparison
                        const newDateObj = new Date(newDate);
                        const currentDateObj = new Date(currentDate);
                        if (newDateObj < currentDateObj) {
                            errors.push('Cannot reschedule to a date earlier than the original schedule.');
                            document.getElementById('new_date').classList.add('is-invalid');
                        }

                        // Rescheduling allowed check
                        const reschedulingAllowed = true; // Replace with actual check
                        if (!reschedulingAllowed) {
                            errors.push('Rescheduling is only allowed within one to two weeks from the original schedule.');
                            document.getElementById('new_date').classList.add('is-invalid');
                        }
                            
                        // Check if the schedule already exists (this is a placeholder, replace with actual check)
                        const scheduleExists = false; // Replace with actual check
                        if (scheduleExists) {
                            errors.push('Schedule already exists for the selected date, time, and room. Please choose a different slot.');
                            document.getElementById('new_date').classList.add('is-invalid');
                            document.getElementById('new_time').classList.add('is-invalid');
                            document.getElementById('new_lab').classList.add('is-invalid');
                        }

                        // Display errors or proceed
                        if (errors.length > 0) {
                            errorMessage.innerHTML = errors.join('<br>');
                            errorMessage.style.display = 'block'; // Ensure error message is visible
                        } else {                            
                            errorMessage.style.display = 'none'; // Hide error message if no errors
                            const url = `/reassignFD/${scheduleId}/`;
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = url;
                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                            form.innerHTML = `
                                <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                <input type="hidden" name="new_date" value="${newDate}">
                                <input type="hidden" name="new_time" value="${newTime}">
                                <input type="hidden" name="new_lab" value="${newLab}">
                                <input type="hidden" name="last_used_date" value="${last_used_date}">
                            `;
                            document.body.appendChild(form);
                            form.submit();
                        }
                    };
                };
            });

            // Adjust table layout before and after printing
            window.addEventListener('beforeprint', function() {
                document.querySelectorAll('.lunch-break td').forEach(function(td) {
                    td.setAttribute('colspan', '6');
                });
            });

            window.addEventListener('afterprint', function() {
                document.querySelectorAll('.lunch-break td').forEach(function(td) {
                    td.setAttribute('colspan', '7');
                });
            });

            // Check for conflict and message parameters in the URL
            const urlParams = new URLSearchParams(window.location.search);
            const conflict = urlParams.get('conflict');
            const message = urlParams.get('message');

            // if (conflict && message) {
            //     const errorMessage = document.getElementById('error_message');
            //     errorMessage.innerHTML = decodeURIComponent(message.replace(/\+/g, ' '));
            //     errorMessage.style.display = 'block';
            //     $('#reassignModal').modal('show');
            // }
        });
    </script>

    <!-- this for the generation of schedule to restrict past dates -->
    <!-- <script>
        document.addEventListener('DOMContentLoaded', function () {
            const dateInput = document.getElementById('start_date');

            // Disable past dates
            const today = new Date().toISOString().split('T')[0];
            dateInput.setAttribute('min', today);

            // Disable Saturdays and Sundays
            dateInput.addEventListener('input', function () {
                const selectedDate = new Date(this.value);

                // Get the day of the week (0 for Sunday, 6 for Saturday)
                const day = selectedDate.getUTCDay();

                // If the selected day is Saturday (6) or Sunday (0), clear the input
                if (day === 0 || day === 6) {
                    alert('Saturdays and Sundays are not allowed. Please select a weekday.');
                    this.value = ''; // Clear the invalid date
                }
            });
        });
    </script> -->

    <!-- this for the generation of schedule to restrict past dates -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get today's date in YYYY-MM-DD format
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are zero-based
            const year = today.getFullYear();
            const formattedToday = `${year}-${month}-${day}`;

            // Set the minimum date to today initially
            const startDateInput = document.getElementById('start_date');
            startDateInput.setAttribute('min', formattedToday);

            // Get last used date from Django context
            const lastUsedDateStr = "{{ last_used_dateMD }}"; // Format: "October 21, 2024"

            // Check if lastUsedDate is valid
            if (lastUsedDateStr) {
                // Parse lastUsedDate to a Date object
                const lastUsedDate = new Date(lastUsedDateStr);

                // Check if lastUsedDate is a valid date
                if (!isNaN(lastUsedDate.getTime())) {
                    // If last used date is in the past
                    if (lastUsedDate < today) {
                        // Set min to today's date
                        startDateInput.setAttribute('min', formattedToday);
                    } else {
                        // Last used date is in the future; set min to the day after last used date
                        const dayAfterLastUsed = new Date(lastUsedDate);
                        dayAfterLastUsed.setDate(lastUsedDate.getDate() + 1);

                        const nextAvailableDay = String(dayAfterLastUsed.getDate()).padStart(2, '0');
                        const nextAvailableMonth = String(dayAfterLastUsed.getMonth() + 1).padStart(2, '0');
                        const nextAvailableYear = dayAfterLastUsed.getFullYear();
                        const formattedNextAvailableDate = `${nextAvailableYear}-${nextAvailableMonth}-${nextAvailableDay}`;

                        startDateInput.setAttribute('min', formattedNextAvailableDate);
                    }
                }
            }

            // Function to check if a date is a weekend
            function isWeekend(dateString) {
                const date = new Date(dateString);
                const day = date.getDay();
                return day === 0 || day === 6; // 0 is Sunday, 6 is Saturday
            }

            // Add an event listener to the date input to prevent selecting weekends
            startDateInput.addEventListener('change', function() {
                const selectedDate = startDateInput.value;

                // If the selected date is a weekend, reset the input and alert the user
                if (isWeekend(selectedDate)) {
                    alert("Saturdays and Sundays are not allowed. Please select a weekday.");
                    startDateInput.value = ""; // Clear the input
                }
            });
        });
    </script>

    <!-- this script used for the date restrictions -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get today's date in YYYY-MM-DD format
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are zero-based
            const year = today.getFullYear();
            const formattedToday = `${year}-${month}-${day}`;
        
            // Get the start date input element
            const startDateInput = document.getElementById('new_date');
        
            // Set the minimum date to today initially
            startDateInput.setAttribute('min', formattedToday);
        
            // Get last used date from Django context
            const lastUsedDateStr = "{{ last_used_date }}"; // Format: "October 21, 2024"
        
            // Function to format date as YYYY-MM-DD
            function formatDate(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${year}-${month}-${day}`;
            }
        
            // Function to check if a date is a weekend (Saturday or Sunday)
            function isWeekend(date) {
                const dayOfWeek = date.getDay();
                return dayOfWeek === 0 || dayOfWeek === 6; // 0 = Sunday, 6 = Saturday
            }
        
            // Check if lastUsedDate is valid
            if (lastUsedDateStr) {
                // Parse lastUsedDate to a Date object
                const lastUsedDate = new Date(lastUsedDateStr);
        
                // Check if lastUsedDate is a valid date
                if (!isNaN(lastUsedDate.getTime())) {
                    // Calculate the next available date (day after the last used date)
                    const dayAfterLastUsed = new Date(lastUsedDate);
                    dayAfterLastUsed.setDate(lastUsedDate.getDate());
        
                    // Set the min date to the day after the last used date
                    const formattedNextAvailableDate = formatDate(dayAfterLastUsed);
                    startDateInput.setAttribute('min', formattedNextAvailableDate);
        
                    // Calculate the maximum date (21 days after the last used date)
                    const maxDate = new Date(lastUsedDate);
                    maxDate.setDate(lastUsedDate.getDate() + 14);
        
                    // Set the max date to 21 days after the last used date
                    const formattedMaxAvailableDate = formatDate(maxDate);
                    startDateInput.setAttribute('max', formattedMaxAvailableDate);
                }
            }
        
            // Add an event listener to disable weekends
            startDateInput.addEventListener('input', function() {
                const selectedDate = new Date(this.value);
        
                // If the selected date is a weekend, clear the input and show an alert
                if (isWeekend(selectedDate)) {
                    alert('Weekends (Saturday and Sunday) are not selectable. Please choose a weekday.');
                    this.value = ''; // Clear the selected value
                }
            });
        });
    </script>

    <!-- Confirmation Modal for resetting -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Confirm Reset</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to reset the schedule? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <a href="{% url 'reset_scheduleFD' %}" class="btn btn-danger">Reset Schedule</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Bootstrap JS and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</body>
</html>